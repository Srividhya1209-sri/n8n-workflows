[{"updatedAt":"2025-11-25T18:42:10.000Z","createdAt":"2025-10-03T10:03:52.148Z","id":"MbmM2JS2MHzBT1dG","name":"GIA","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"triggerAtHour":9},{"triggerAtHour":16}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-2800,208],"id":"f6ef58e7-41ee-4c8a-98a0-43cf409a0e62","name":"Schedule Trigger"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const dateStr = $json.Date;     // e.g. \"22-09-2025\"\nconst timeStr = $json.Time;     // e.g. \"3:30 PM - 4:00 PM\"\n\nif (!dateStr || !timeStr) {\n  return { json: { ...$json, error: \"Missing Date or Time\" } };\n}\n\nconst [startStr, endStr] = timeStr.split(\"-\").map(s => s.trim());\n\nfunction parseTime(timeStr) {\n  if (!timeStr) return null;\n  const match = timeStr.match(/(\\d{1,2}):(\\d{2})\\s*(AM|PM)/i);\n  if (!match) return null;\n  let h = parseInt(match[1], 10);\n  const m = parseInt(match[2], 10);\n  const meridian = match[3].toUpperCase();\n  if (meridian === \"PM\" && h !== 12) h += 12;\n  if (meridian === \"AM\" && h === 12) h = 0;\n  return { hour: h, minute: m };\n}\n\nconst startTime = parseTime(startStr);\nconst endTime = parseTime(endStr);\n\nif (!startTime || !endTime) {\n  return { json: { ...$json, error: \"Invalid time format\", debug: { startStr, endStr } } };\n}\n\nconst [day, month, year] = dateStr.split(\"-\").map(n => parseInt(n, 10));\n\nif (!day || !month || !year) {\n  return { json: { ...$json, error: \"Invalid date format\", debug: { dateStr } } };\n}\n\nconst startDate = new Date(year, month - 1, day, startTime.hour, startTime.minute);\nconst endDate = new Date(year, month - 1, day, endTime.hour, endTime.minute);\n\nif (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {\n  return { json: { ...$json, error: \"Invalid Date object\", debug: { startDate: startDate.toString(), endDate: endDate.toString() } } };\n}\n\n// Convert to ISO string in local timezone (+05:30 for IST)\nfunction toISTISOString(date) {\n  const tzOffsetMs = 5.5 * 60 * 60000; // 5h30m in ms\n  const ist = new Date(date.getTime() - date.getTimezoneOffset() * 60000 + tzOffsetMs);\n  return ist.toISOString().replace(\"Z\", \"+05:30\");\n}\n\nreturn {\n  json: {\n    ...$json,\n    start: toISTISOString(startDate),\n    end: toISTISOString(endDate)\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1472,960],"id":"ea3e9a16-5a5e-415c-9161-4f31f55b5269","name":"date&time"},{"parameters":{"calendar":{"__rl":true,"value":"giahcs@gmail.com","mode":"list","cachedResultName":"giahcs@gmail.com"},"start":"={{ $json.start }}","end":"={{ $json.end }}","additionalFields":{"description":"={{ $json['Schedule Status'] }}\n{{ $json.Mobile }}","summary":"={{ $json['Patient Name'] }}"}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[-1296,960],"id":"d6eeb484-cfd3-41ee-b731-d0d44fed19ad","name":"Calendar","credentials":{"googleCalendarOAuth2Api":{"id":"pSQXiyrkdNbchaVW","name":"Google Calendar account"}}},{"parameters":{"documentId":{"__rl":true,"value":"1JQoUXTPwaPA7kmQYnzQTEKsIc0C4kai0dxvOBrF-vbU","mode":"list","cachedResultName":"Customer","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1JQoUXTPwaPA7kmQYnzQTEKsIc0C4kai0dxvOBrF-vbU/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1JQoUXTPwaPA7kmQYnzQTEKsIc0C4kai0dxvOBrF-vbU/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[-1776,960],"id":"a269eb95-ba4e-406e-8b1c-db628dfdc288","name":"Customer","credentials":{"googleSheetsOAuth2Api":{"id":"ifdN5jt9hSD3ytNJ","name":"Google Sheets account 4"}}},{"parameters":{"url":"=https://api.retellai.com/v2/get-call/{{ $('Voice agent for caregiver').item.json.call_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer key_f4ec5170781e8a750806dc78b966"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1072,48],"id":"956275a3-e019-4297-878a-d9061ec540f2","name":"call summary1"},{"parameters":{"mode":"chooseBranch","useDataOfInput":2},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-1312,704],"id":"9b870633-8e40-40bf-8a63-cc32192b6296","name":"Merge"},{"parameters":{"jsCode":"const MS_PER_DAY = 24 * 60 * 60 * 1000;\nconst today = new Date();\ntoday.setHours(0, 0, 0, 0);\n\n// --- Helper functions ---\n\nconst normalizeKey = k =>\n  k.toString().trim().toLowerCase().replace(/[^a-z0-9]/g, '');\n\nfunction tryParseDate(val) {\n  if (!val || String(val).trim() === '') return null;\n  if (val instanceof Date) {\n    val.setHours(0, 0, 0, 0);\n    return val;\n  }\n  if (typeof val === 'number') {\n    if (val > 1e12) {\n      const d = new Date(val);\n      d.setHours(0, 0, 0, 0);\n      return d;\n    } else {\n      const excelEpoch = new Date(Date.UTC(1899, 11, 30));\n      const d = new Date(excelEpoch.getTime() + val * MS_PER_DAY);\n      d.setHours(0, 0, 0, 0);\n      return d;\n    }\n  }\n  let s = String(val).trim();\n  const match = s.match(/(\\d{1,4}[-\\/]\\d{1,2}[-\\/]\\d{1,4})/);\n  if (match) s = match[1];\n  const parsed = Date.parse(s);\n  if (!isNaN(parsed)) {\n    const d = new Date(parsed);\n    d.setHours(0, 0, 0, 0);\n    return d;\n  }\n  s = s.replace(/\\//g, '-');\n  const parts = s.split('-').map(p => p.trim());\n  if (parts.length === 3) {\n    if (parts[0].length === 4) {\n      const y = +parts[0],\n        m = +parts[1],\n        d = +parts[2];\n      return new Date(y, m - 1, d);\n    } else {\n      const d = +parts[0],\n        m = +parts[1],\n        y = +parts[2];\n      return new Date(y, m - 1, d);\n    }\n  }\n  return null;\n}\n\nfunction formatPhone(raw) {\n  if (!raw) return '';\n  let s = String(raw).replace(/\\D/g, '');\n  if (s.length === 0) return '';\n  if (s.length === 10) s = '91' + s; // assume India default\n  return '+' + s;\n}\n\n// --- Main Processing ---\n\nlet results = [];\n\nitems.forEach((item, index) => {\n  const row = item.json || {};\n  const norm = {};\n  Object.keys(row).forEach(k => {\n    norm[normalizeKey(k)] = row[k];\n  });\n\n  const findValue = subs => {\n    for (const nk of Object.keys(norm)) {\n      if (subs.every(s => nk.includes(s))) return norm[nk];\n    }\n    return undefined;\n  };\n\n  // Extract relevant fields\n  let insRaw =\n    findValue(['insur', 'expir']) ||\n    norm['insuranceexpiry'] ||\n    norm['expirydate'] ||\n    row['Insurance Expiry'] ||\n    row['Insurance Expiry '];\n\n  let apptRaw =\n    findValue(['appoint', 'date']) ||\n    norm['date'] ||\n    norm['appointmentdate'] ||\n    row['Date'];\n\n  let phoneRaw =\n    findValue(['mobile']) || findValue(['phone']) || row.Mobile || row.Phone;\n\n  const insDate = tryParseDate(insRaw);\n  const apptDate = tryParseDate(apptRaw);\n\n  let reminders = [];\n\n  // ---- INSURANCE REMINDERS ----\n  if (insDate) {\n    const diffIns = Math.round(\n      (insDate.getTime() - today.getTime()) / MS_PER_DAY\n    );\n    if ([30, 15, 7].includes(diffIns)) {\n      reminders.push({\n        type: `${diffIns}-day`,\n        category: 'insurance',\n        timing: 'upcoming',\n      });\n    }\n  }\n\n  // ---- APPOINTMENT REMINDERS ----\n  if (apptDate) {\n    const diffAppt = Math.round(\n      (apptDate.getTime() - today.getTime()) / MS_PER_DAY\n    );\n    if ([7, 3, 1].includes(diffAppt)) {\n      reminders.push({\n        type: `${diffAppt}-day`,\n        category: 'appointment',\n        timing: 'upcoming',\n      });\n    }\n  }\n\n  // ---- PUSH ONLY IF THERE IS A REMINDER ----\n  if (reminders.length > 0) {\n    results.push({\n      json: {\n        ...row,\n        to_number: formatPhone(phoneRaw),\n        reminders,\n        _parsed_insurance_expiry: insDate\n          ? insDate.toLocaleDateString('en-CA')\n          : null,\n        _parsed_appointment_date: apptDate\n          ? apptDate.toLocaleDateString('en-CA')\n          : null,\n      },\n    });\n  }\n});\n\n// ---- RETURN RESULTS ----\nreturn results.length > 0\n  ? results\n  : [{ json: { message: 'No reminders today' } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1024,960],"id":"ab450511-1d15-4438-a60c-d0a669f51304","name":"Reminder check","alwaysOutputData":true},{"parameters":{"jsCode":"return items.map(item => {\n  const raw = item.json || {};\n\n  // Normalize keys\n  const row = {};\n  for (const key in raw) {\n    row[key.toLowerCase().trim()] = raw[key];\n  }\n\n  // Extract fields\n  const patientName = row[\"patient name\"]?.toString().trim() || \"Unknown\";\n\n  // Phone number\n  let phone = row[\"mobile\"] ? row[\"mobile\"].toString().trim() : \"\";\n  if (phone) {\n    phone = phone.replace(/\\D/g, \"\");\n    if (!phone.startsWith(\"1\")) phone = \"1\" + phone;\n    phone = \"+\" + phone;\n  }\n\n  const appointmentDateStr = row[\"date\"]?.toString().trim() || \"\";\n  const appointmentTime = row[\"time\"]?.toString().trim() || \"N/A\";\n  const insuranceProvider = row[\"insurance provider\"]?.toString().trim() || \"\";\n  const expiryDate = row[\"insurance expiry\"]?.toString().trim() || \"\";\n  const providerName = row[\"provider name\"]?.toString().trim() || \"your provider\";\n  const officeNumber = row[\"office number\"]?.toString().trim() || \"508-304-6985\";\n\n  // ----------------------\n  // Parse date safely\n  // ----------------------\n  const parseDate = (str) => {\n    if (!str) return null;\n    // Normalize delimiters\n    str = str.replace(/\\./g, \"-\").replace(/\\//g, \"-\");\n    const parts = str.split(\"-\");\n    if (parts.length === 3) {\n      // Detect format by position of year\n      if (parts[0].length === 4) {\n        // yyyy-mm-dd\n        return new Date(`${parts[0]}-${parts[1]}-${parts[2]}`);\n      } else if (parts[2].length === 4) {\n        // dd-mm-yyyy or mm-dd-yyyy â†’ assume day first (common in India)\n        return new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);\n      }\n    }\n    // Fallback to direct Date parse\n    return new Date(str);\n  };\n\n  const appointmentDate = parseDate(appointmentDateStr);\n  const today = new Date();\n\n  // Calculate days difference\n  let diffDays = NaN;\n  if (appointmentDate instanceof Date && !isNaN(appointmentDate)) {\n    const diffMs = appointmentDate.setHours(0,0,0,0) - today.setHours(0,0,0,0);\n    diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));\n  }\n\n  // ----------------------\n  // Decide scenario\n  // ----------------------\n  let scenario = \"\";\n  let message = \"\";\n\n  if (expiryDate) {\n    scenario = \"Insurance Expiry Reminder\";\n    message = `Hello ${patientName}, this is Sarah from GIA Home Care Services. Your ${insuranceProvider || \"health\"} insurance will expire on ${expiryDate}. Thank you.`;\n  } else if (!isNaN(diffDays)) {\n    if (diffDays === 7) {\n      scenario = \"Appointment Reminder â€“ 7-Day\";\n      message = `Hello ${patientName}, this is Sarah from GIA Home Care Services. Iâ€™m reminding you of your appointment with ${providerName} on ${appointmentDateStr} at ${appointmentTime}. If you need to reschedule, please call us at ${officeNumber}. We look forward to seeing you!`;\n    } else if (diffDays === 3) {\n      scenario = \"Appointment Reminder â€“ 3-Day\";\n      message = `Hello ${patientName}, this is Sarah from GIA Home Care Services. This is a reminder of your appointment with ${providerName} in 3 days, on ${appointmentDateStr} at ${appointmentTime}. Please arrive 15 minutes early. If youâ€™re unwell, call us before your visit.`;\n    } else if (diffDays === 1) {\n      scenario = \"Appointment Reminder â€“ 1-Day\";\n      message = `Hello ${patientName}, this is Sarah from GIA Home Care Services. Iâ€™m reminding you about your appointment tomorrow, ${appointmentDateStr} at ${appointmentTime} with ${providerName}. If you need to reschedule, please call us. Thank you!`;\n    } else if (diffDays === 0) {\n      scenario = \"Appointment Reminder â€“ Today\";\n      message = `Hello ${patientName}, this is Sarah from GIA Home Care Services. You have an appointment today (${appointmentDateStr}) at ${appointmentTime} with ${providerName}. Please arrive on time. Thank you!`;\n    } else {\n      scenario = \"General Appointment Reminder\";\n      message = `Hello ${patientName}, this is Sarah from GIA Home Care Services. This is a reminder of your appointment with ${providerName} on ${appointmentDateStr} at ${appointmentTime}. Thank you.`;\n    }\n  } else {\n    scenario = \"General Reminder\";\n    message = `Hello ${patientName}, this is Sarah from GIA Home Care Services. This is a courtesy reminder from our office.`;\n  }\n\n  // ----------------------\n  // Return payload\n  // ----------------------\n  return {\n    json: {\n      from_number: \"+15086257920\",\n      to_number: phone,\n      agent_id: \"agent_ccd42f6c2d5e3b8a25ee78d458\",\n      retell_llm_dynamic_variables: {\n        patient_name: patientName,\n        insurance_provider: insuranceProvider || \"N/A\",\n        expiry_date: expiryDate || \"N/A\",\n        appointment_date: appointmentDateStr || \"N/A\",\n        appointment_time: appointmentTime,\n        provider_name: providerName,\n        office_number: officeNumber,\n        scenario: scenario,\n        message: message\n      }\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-832,960],"id":"847b90de-653a-4479-9f04-574a420da0a2","name":"call +"},{"parameters":{"jsCode":"// Code2 node\nconst updatedItems = items.map(item => {\n  // Add current date\n  item.json.current_date = new Date().toISOString().split('T')[0];\n\n  // Clean up to_number\n  if (item.json.to_number && item.json.to_number.trim() !== \"\") {\n    item.json.to_number = item.json.to_number.trim();\n  } else {\n    delete item.json.to_number;  // remove field completely\n  }\n\n  return item;\n});\n\nreturn updatedItems;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-608,960],"id":"e1b89a04-ffc7-4cbd-a122-a473d312a1ec","name":"current date"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"from_number\": \"+15086257920\",\n  \"to_number\": \"{{ $json.to_number }}\",\n  \"agent_id\": \"agent_ccd42f6c2d5e3b8a25ee78d458\",\n  \"agent_version\": 6,\n  \"retell_llm_dynamic_variables\": {\n    \"patient_name\": \"{{ $json.retell_llm_dynamic_variables.patient_name }}\",\n    \"appointment_date\": \"{{ $json.retell_llm_dynamic_variables.appointment_date }}\",\n    \"appointment_time\": \"{{ $json.retell_llm_dynamic_variables.appointment_time }}\",\n    \"insurance_provider\": \"{{ $json.retell_llm_dynamic_variables.insurance_provider }}\",\n    \"expiry_date\": \"{{ $json.retell_llm_dynamic_variables.expiry_date }}\",\n    \"scenario\": \"{{ $json.retell_llm_dynamic_variables.scenario }}\",\n    \"message\": \"{{ $json.retell_llm_dynamic_variables.message }}\"\n  }\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-416,960],"id":"a96e7787-8a37-4774-8302-1f851ae83baa","name":"retell dynamic variables"},{"parameters":{"method":"POST","url":"https://api.retellai.com/v2/create-phone-call","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer key_f4ec5170781e8a750806dc78b966"},{"name":"Content-Type","value":"application/json"},{"name":"Agent_id","value":"=agent_ccd42f6c2d5e3b8a25ee78d458"},{"name":"Retell_llm","value":"=llm_3cb665ddffbd7d51e543fb902168"},{"name":"Agent_version","value":"6"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"from_number","value":"=+15086257920"},{"name":"to_number","value":"={{ $json.to_number }}"},{"name":"retell_llm_dynamic_variables","value":"={{ $json.retell_llm_dynamic_variables }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-208,960],"id":"2dfd2a3f-0a36-4f82-acdb-161dbc1a22b0","name":"Voice agent for customer","alwaysOutputData":true},{"parameters":{"jsCode":"return items.map(item => {\n  const data = item.json || {};\n  const vars = data.retell_llm_dynamic_variables || {};\n\n  const caregiver = vars.caregiver || \"Caregiver\";\n  const member_name = vars.member_name || \"Member\";\n  const first_name = vars.first_name || caregiver || \"Caregiver\";\n  const scenario = (vars.scenario || \"\").trim();\n  const log_due_date = vars.log_due_date || \"\";\n  const assignment_date = vars.assignment_date || \"\";\n  const clinician_name = vars.clinician_name || \"\";\n  const clinician_contact = vars.clinician_contact || \"\";\n  const clinician_role = vars.clinician_role || \"\";\n\n  let message = \"\";\n\n  switch (scenario) {\n\n    // 1ï¸âƒ£ Caregiver Log â€“ Missing\n    case \"Caregiver Log â€“ Missing\":\n      message = `Hello ${caregiver}, this is Sarah from GIA Home Care Services. We havenâ€™t received your caregiver log for ${log_due_date || \"the due date\"}. Please submit it as soon as possible to avoid payment delays. Thank you.`;\n      break;\n\n    // 2ï¸âƒ£ Caregiver Log â€“ Incomplete\n    case \"Caregiver Log â€“ Incomplete\":\n      message = `Hi ${caregiver}, Sarah from GIA Home Care Services here. The log you have submitted is incomplete. Please check the log you submitted, complete it, and resend the corrected log. Thank you.`;\n      break;\n\n    // 3ï¸âƒ£ Caregiver Vacation Reminder\n    case \"Caregiver Vacation Reminder\":\n      message = `Hello ${caregiver}, this is Sarah from GIA Home Care Services. Youâ€™re eligible for 14 days paid respite. Requests must be made 30 days in advance. A Vacation Request Form can be sent if needed. Thank you.`;\n      break;\n\n    // 4ï¸âƒ£ Monthly Visit â€“ Urgent\n    case \"Monthly Visit â€“ Urgent\":\n      message = `Hello ${caregiver}, this is Sarah from GIA Home Care Services. Your monthly AFC visit is still pending. Please call 508-304-6985 to schedule. Thank you.`;\n      break;\n\n    // 5ï¸âƒ£ Annual Physical Reminder\n    case \"Annual Physical Reminder\":\n      message = `Hello ${caregiver}, this is Sarah from GIA Home Care Services. Your memberâ€™s annual physical has expired or will expire soon. Please schedule and provide the date. Thank you.`;\n      break;\n\n    // 6ï¸âƒ£ New Clinician Assignment\n    case \"New Clinician Assignment\":\n      message = `Hello ${member_name}, this is Sarah from GIA Home Care Services. Starting ${assignment_date || \"the assignment date\"}, your new ${clinician_role || \"clinician\"} is ${clinician_name || \"our team member\"}, reachable at ${clinician_contact || \"the office\"}. Thank you.`;\n      break;\n\n    // 7ï¸âƒ£ Photo ID Request\n    case \"Photo ID Request\":\n      message = `Hello ${first_name}, this is Sarah from GIA Home Care Services. Your photo ID is expiring soon. Please send us a copy of your valid ID. Thank you.`;\n      break;\n\n    // 8ï¸âƒ£ New Caregiver Welcome\n    case \"New Caregiver Welcome\":\n      message = `Hello ${caregiver}, this is Sarah from GIA Home Care Services. Congratulations on your approval as a caregiver. Stipend payments start after the admission visit. Thank you.`;\n      break;\n\n    // ðŸ§© Default fallback\n    default:\n      message = vars.message || `Hi ${caregiver}, this is a reminder from GIA Home Care Services.`;\n  }\n\n  // âœ… Save message back to variables\n  data.retell_llm_dynamic_variables.message = message;\n\n  // âœ… Ensure phone number format\n  let phone = data.to_number || \"\";\n  if (phone && !phone.startsWith(\"+\")) phone = `+1${phone}`;\n\n  return {\n    json: {\n      ...data,\n      to_number: phone\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1216,-320],"id":"a9cdfac5-ae39-43e9-82d4-8b8b660c50cd","name":"Code6"},{"parameters":{"documentId":{"__rl":true,"value":"1n_zBicga5HOLHhkhjF0hvHhIc-APgR6rasQR3MEhvws","mode":"list","cachedResultName":"CAREGIVER","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1n_zBicga5HOLHhkhjF0hvHhIc-APgR6rasQR3MEhvws/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1n_zBicga5HOLHhkhjF0hvHhIc-APgR6rasQR3MEhvws/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[-1776,-320],"id":"3f58ec2d-efbf-45a6-8509-d4151ccb2ded","name":"Get row(s) in sheet1","credentials":{"googleSheetsOAuth2Api":{"id":"ifdN5jt9hSD3ytNJ","name":"Google Sheets account 4"}}},{"parameters":{"jsCode":"return items.map(item => {\n  const row = item.json || {};\n\n  // Normalize keys (spaces â†’ underscores, lowercase)\n  const data = {};\n  for (let key in row) {\n    data[key.trim().toLowerCase().replace(/\\s+/g, \"_\")] = row[key];\n  }\n\n  // Extract core fields\n  const caregiver = data[\"caregiver_name\"] || data[\"caregiver\"] || \"Caregiver\";\n  const member_name = data[\"member_name\"] || caregiver;\n  const first_name = data[\"first_name\"] || caregiver;\n  const log_status = data[\"log_status\"] || \"\";\n  const log_due_date = data[\"log_due_date\"] || \"N/A\"; // default if empty\n  const assignment_date = data[\"assignment_date\"] || data[\"assignemnt_date\"] || \"\";\n  const clinician_role = data[\"clinician_role\"] || \"\";\n  const clinician_name = data[\"clinician_name\"] || \"\";\n  const clinician_contact = data[\"clinician_contact\"] || \"\";\n\n  // Phone normalization\n  const rawPhoneVal = data[\"phone_number\"] || data[\"phone\"] || \"\";\n  const phoneRaw = rawPhoneVal == null ? \"\" : String(rawPhoneVal).trim();\n  let phone = \"\";\n\n  if (phoneRaw) {\n    if (phoneRaw.startsWith(\"+\")) {\n      phone = phoneRaw;\n    } else {\n      const digits = phoneRaw.replace(/\\D+/g, \"\");\n      if (digits.length === 10) phone = `+91${digits}`;\n      else if (digits.length === 11 && digits.startsWith(\"0\")) phone = `+91${digits.slice(1)}`;\n      else if (digits.length === 12 && digits.startsWith(\"91\")) phone = `+${digits}`;\n      else phone = `+91${digits}`;\n    }\n  }\n\n  // Determine scenario (auto-detect if not set)\n  let scenario = data[\"scenario\"] || \"\";\n  if (!scenario) {\n    const status = log_status.toLowerCase();\n    if (status === \"completed\") scenario = \"Caregiver Log â€“ Completed\";\n    else if (status === \"missing\") scenario = \"Caregiver Log â€“ Missing\";\n    else if (status === \"incomplete\") scenario = \"Caregiver Log â€“ Incomplete\";\n  }\n\n  // Current date\n  const today = new Date();\n  const formattedDate = `${today.getDate().toString().padStart(2, '0')}-${(today.getMonth() + 1)\n    .toString()\n    .padStart(2, '0')}-${today.getFullYear()}`;\n\n  // Message template selection\n  let template = data[\"message_template\"] || \"\";\n\n  if (!template) {\n    switch (scenario) {\n      case \"Caregiver Log â€“ Missing\":\n        template = \"Hello $caregiver, this is Sarah from GIA Home Care Services. We havenâ€™t received your caregiver log for $log_due_date. Please submit it as soon as possible to avoid payment delays. Thank you.\";\n        break;\n\n      case \"Caregiver Log â€“ Incomplete\":\n        template = \"Hi $caregiver, Sarah from GIA Home Care Services here. The log you have submitted is incomplete. Please check the log you submitted, complete it, and resend the corrected log. Thank you!\";\n        break;\n\n      case \"Caregiver Vacation Reminder\":\n        template = \"Hello $caregiver, this is Sarah from GIA Home Care Services. Youâ€™re eligible for 14 days paid respite. Requests must be made 30 days in advance. A Vacation Request Form can be sent if needed. Thank you.\";\n        break;\n\n      case \"Monthly Visit â€“ Urgent\":\n        template = \"Hello $caregiver, this is Sarah from GIA Home Care Services. Your monthly AFC visit is still pending. Please call 508-304-6985 to schedule. Thank you.\";\n        break;\n\n      case \"Annual Physical Reminder\":\n        template = \"Hello $caregiver, this is Sarah from GIA Home Care Services. Your memberâ€™s annual physical has expired or will expire soon. Please schedule and provide the date. Thank you.\";\n        break;\n\n      case \"New Clinician Assignment\":\n        template = \"Hello $member_name, this is Sarah from GIA Home Care Services. Starting $assignment_date, your new $clinician_role is $clinician_name, reachable at $clinician_contact. Thank you.\";\n        break;\n\n      case \"Photo ID Request\":\n        template = \"Hello $first_name, this is Sarah from GIA Home Care Services. Your photo ID is expiring soon. Please send us a copy of your valid ID. Thank you.\";\n        break;\n\n      case \"New Caregiver Welcome\":\n        template = \"Hello $caregiver, this is Sarah from GIA Home Care Services. Congratulations on your approval as a caregiver. Stipend payments start after the admission visit. Thank you.\";\n        break;\n\n      case \"Caregiver Log â€“ Completed\":\n        template = \"Hello $caregiver, this is Sarah from GIA Home Care Services. Thank you for submitting your caregiver log. Everything looks good!\";\n        break;\n\n      default:\n        template = \"Hello $caregiver, this is Sarah from GIA Home Care Services. Thank you.\";\n    }\n  }\n\n  // Replace placeholders dynamically\n  const message = template\n    .replace(/\\$caregiver/g, caregiver)\n    .replace(/\\$member_name/g, member_name)\n    .replace(/\\$first_name/g, first_name)\n    .replace(/\\$log_status/g, log_status)\n    .replace(/\\$log_due_date/g, log_due_date)\n    .replace(/\\$assignment_date/g, assignment_date)\n    .replace(/\\$clinician_role/g, clinician_role)\n    .replace(/\\$clinician_name/g, clinician_name)\n    .replace(/\\$clinician_contact/g, clinician_contact)\n    .replace(/\\$today/g, formattedDate);\n\n  // Return normalized structure\n  return {\n    json: {\n      caregiver,\n      member_name,\n      first_name,\n      phone_number: phone,\n      log_status,\n      log_due_date,\n      assignment_date,\n      clinician_role,\n      clinician_name,\n      clinician_contact,\n      scenario,\n      message,\n      today: formattedDate,\n\n      // consistent Retell dynamic variable names\n      retell_llm_dynamic_variables: {\n        caregiver,\n        log_status,\n        log_due_date,\n        message,\n        scenario\n      }\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1584,-320],"id":"7cc58f85-4abf-48a0-ba12-74ac63fe208c","name":"Code"},{"parameters":{"method":"POST","url":"https://api.retellai.com/v2/create-phone-call","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer key_f4ec5170781e8a750806dc78b966"},{"name":"Content-Type","value":"application/json"},{"name":"Agent-Id","value":"=agent_ccd42f6c2d5e3b8a25ee78d458"},{"name":"Retell_llm","value":"=llm_3cb665ddffbd7d51e543fb902168"},{"name":"Agent_version","value":"5"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"from_number\": \"+15086257920\",\n  \"to_number\": \"{{ $json.phone_number || $json.to_number }}\",\n  \"agent_id\": \"agent_ccd42f6c2d5e3b8a25ee78d458\",\n  \"agent_version\": 5,\n  \"async\": true,\n  \"force_new_session\": true,\n  \"clear_agent_memory\": true,\n  \"conversation_id\": \"{{ ($json.phone_number || $json.caregiver || $json.to_number) + '_' + $now }}\",\n\n  \"variables\": {\n    \"reset_session\": true\n  },\n\n  \"retell_llm_dynamic_variables\": {\n    \"caregiver\": \"{{ $json.retell_llm_dynamic_variables.caregiver }}\",\n    \"log_status\": \"{{ $json.retell_llm_dynamic_variables.log_status }}\",\n    \"log_due_date\": \"{{ $json.retell_llm_dynamic_variables.log_due_date }}\",\n    \"assignment_date\": \"{{ $json.retell_llm_dynamic_variables.assignment_date }}\",\n    \"clinician_role\": \"{{ $json.retell_llm_dynamic_variables.clinician_role }}\",\n    \"clinician_name\": \"{{ $json.retell_llm_dynamic_variables.clinician_name }}\",\n    \"clinician_contact\": \"{{ $json.retell_llm_dynamic_variables.clinician_contact }}\",\n    \"message\": \"{{ $json.retell_llm_dynamic_variables.message }}\",\n    \"scenario\": \"{{ $json.retell_llm_dynamic_variables.scenario }}\"\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1024,-320],"id":"1c301f78-3a2f-41e4-a441-268efbf57959","name":"Voice agent for caregiver"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"from_number\": \"+15086257920\",\n  \"to_number\": \"{{ $json.phone_number || $json.to_number }}\",\n  \"agent_id\": \"agent_ccd42f6c2d5e3b8a25ee78d458\",\n  \"clear_agent_memory\": true,\n   \"async\": true,\n  \"agent_version\": 5,\n  \"retell_llm_dynamic_variables\": {\n    \"caregiver\": \"{{ $json.caregiver }}\",\n    \"log_status\": \"{{ $json.log_status }}\",\n    \"log_due_date\": \"{{ $json.log_due_date }}\",\n    \"assignment_date\": \"{{ $json.assignment_date }}\",\n    \"clinician_role\": \"{{ $json.clinician_role }}\",\n    \"clinician_name\": \"{{ $json.clinician_name }}\",\n    \"clinician_contact\": \"{{ $json.clinician_contact }}\",\n    \"message\": \"{{ $json.message }}\",\n    \"scenario\": \"{{ $json.scenario }}\"\n  }\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1392,-320],"id":"eb61191d-0cf1-4962-b6ea-51cdff9a728f","name":"Edit Fields1"},{"parameters":{"jsCode":"return items.map(item => {\n  const data = item.json;\n\n  // Remove large or unnecessary fields\n         // remove transcript object\n  delete data.transcript_text;    // remove text version (if exists)\n  delete data.messages;           // remove any message logs\n  delete data.call_audio; \n  delete data.transcript_object;\n  delete data.transcript_with_tool_calls;// optional, if not needed\n\n  return { json: data };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-816,48],"id":"a084a38a-f768-4ed8-ae27-039fc8b3b6ab","name":"to remove anything"},{"parameters":{"jsCode":"// Run for each input item (so all call_ids are processed)\nreturn items.map(item => {\n  return {\n    json: {\n      call_id: item.json.call_id,\n      check_count: 0\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1456,64],"id":"2ef3e82c-b8c1-421d-b3f0-91f02f2e514f","name":"call id"},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1CyYUWyF7n6fxx-sIEfGJqyNymPvAJ7pFdeI3phL7Q9s","mode":"list","cachedResultName":"New Data","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1CyYUWyF7n6fxx-sIEfGJqyNymPvAJ7pFdeI3phL7Q9s/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1CyYUWyF7n6fxx-sIEfGJqyNymPvAJ7pFdeI3phL7Q9s/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"call_id","displayName":"call_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_type","displayName":"call_type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"agent_id","displayName":"agent_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"agent_version","displayName":"agent_version","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"retell_llm_dynamic_variables","displayName":"retell_llm_dynamic_variables","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_status","displayName":"call_status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"start_timestamp","displayName":"start_timestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"end_timestamp","displayName":"end_timestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"duration_ms","displayName":"duration_ms","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"transcript","displayName":"transcript","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"recording_url","displayName":"recording_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"recording_multi_channel_url","displayName":"recording_multi_channel_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"public_log_url","displayName":"public_log_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"disconnection_reason","displayName":"disconnection_reason","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"latency","displayName":"latency","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_cost","displayName":"call_cost","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_analysis","displayName":"call_analysis","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"opt_out_sensitive_data_storage","displayName":"opt_out_sensitive_data_storage","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"data_storage_setting","displayName":"data_storage_setting","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"opt_in_signed_url","displayName":"opt_in_signed_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"llm_token_usage","displayName":"llm_token_usage","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"from_number","displayName":"from_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"to_number","displayName":"to_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"direction","displayName":"direction","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"telephony_identifier","displayName":"telephony_identifier","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[-608,48],"id":"6eee2804-5630-472d-ae7c-46b8f45221db","name":"Append row in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"LZ3OAJFvgzdGCnkM","name":"Google Sheets account"}}},{"parameters":{"amount":2,"unit":"minutes"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-848,-320],"id":"57cc011b-a240-4c64-90af-84c05a5eef96","name":"Wait","webhookId":"0422a03b-ec32-4a52-9765-59aebdeb7dbe"},{"parameters":{"amount":2,"unit":"minutes"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[0,960],"id":"a7451f28-3f04-4b65-a64b-d4b29b4b1085","name":"Wait1","webhookId":"2b668518-4759-4d57-93b2-5bbe5bdd8b0f"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"98d7bccd-36bb-4f66-9ff7-b9928c066191","leftValue":"={{ $json.call_status }}","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1296,64],"id":"a7b8df20-4198-4830-961b-a96a93d4e855","name":"If"},{"parameters":{"amount":20,"unit":"minutes"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-912,256],"id":"29ad66a1-a6af-4464-b7be-dc3739e2a4ab","name":"Wait2","webhookId":"55e2d980-7404-471f-ac97-f9a4f2b6dd96"},{"parameters":{"method":"POST","url":"https://api.retellai.com/v2/create-phone-call","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer key_f4ec5170781e8a750806dc78b966"},{"name":"Content-Type","value":"application/json"},{"name":"Agent-Id","value":"=agent_ccd42f6c2d5e3b8a25ee78d458"},{"name":"Retell_llm","value":"=llm_3cb665ddffbd7d51e543fb902168"},{"name":"Agent_version","value":"5"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"from_number\": \"+15086257920\",\n  \"to_number\": \"{{ $json.phone_number || $json.to_number }}\",\n  \"agent_id\": \"agent_ccd42f6c2d5e3b8a25ee78d458\",\n  \"agent_version\": 5,\n  \"async\": true,\n  \"force_new_session\": true,\n  \"clear_agent_memory\": true,\n  \"conversation_id\": \"{{ ($json.phone_number || $json.caregiver || $json.to_number) + '_' + $now }}\",\n\n  \"variables\": {\n    \"reset_session\": true\n  },\n\n  \"retell_llm_dynamic_variables\": {\n    \"caregiver\": \"{{ $json.retell_llm_dynamic_variables.caregiver }}\",\n    \"log_status\": \"{{ $json.retell_llm_dynamic_variables.log_status }}\",\n    \"log_due_date\": \"{{ $json.retell_llm_dynamic_variables.log_due_date }}\",\n    \"assignment_date\": \"{{ $json.retell_llm_dynamic_variables.assignment_date }}\",\n    \"clinician_role\": \"{{ $json.retell_llm_dynamic_variables.clinician_role }}\",\n    \"clinician_name\": \"{{ $json.retell_llm_dynamic_variables.clinician_name }}\",\n    \"clinician_contact\": \"{{ $json.retell_llm_dynamic_variables.clinician_contact }}\",\n    \"message\": \"{{ $json.retell_llm_dynamic_variables.message }}\",\n    \"scenario\": \"{{ $json.retell_llm_dynamic_variables.scenario }}\"\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-704,256],"id":"f57b915b-b182-4bf4-aad3-30cee14eca18","name":"Voice agent for caregiver2"},{"parameters":{"jsCode":"// Run for each input item (so all call_ids are processed)\nreturn items.map(item => {\n  return {\n    json: {\n      call_id: item.json.call_id,\n      check_count: 0\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1024,1424],"id":"b3f8955d-7fd0-4d71-adac-59e962fa276c","name":"call id1"},{"parameters":{"jsCode":"// Run for each input item (so all call_ids are processed)\nreturn items.map(item => {\n  return {\n    json: {\n      call_id: item.json.call_id,\n      check_count: 0\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-320,256],"id":"0c3a3c3c-04f7-4cf7-9025-b47107931b53","name":"call id2"},{"parameters":{"amount":2,"unit":"minutes"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-512,256],"id":"fa8666c3-35a3-4bc0-871b-f71d8e89265e","name":"Wait3","webhookId":"0422a03b-ec32-4a52-9765-59aebdeb7dbe"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"98d7bccd-36bb-4f66-9ff7-b9928c066191","leftValue":"={{ $json.call_status }}","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-800,1424],"id":"9dc5b3f8-357e-4516-821f-330965d17760","name":"If1"},{"parameters":{"amount":10,"unit":"minutes"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-528,1520],"id":"fc03044c-c328-4c50-8fff-71e358f02ad3","name":"Wait4","webhookId":"55e2d980-7404-471f-ac97-f9a4f2b6dd96"},{"parameters":{"jsCode":"// Run for each input item (so all call_ids are processed)\nreturn items.map(item => {\n  return {\n    json: {\n      call_id: item.json.call_id,\n      check_count: 0\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[32,1520],"id":"d9f3c1d5-e20e-41fb-9b6b-5b6d05fd23f3","name":"call id3"},{"parameters":{"amount":2,"unit":"minutes"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-160,1520],"id":"c514ab17-4739-4f41-9c0f-3f427e78be69","name":"Wait5","webhookId":"0422a03b-ec32-4a52-9765-59aebdeb7dbe"},{"parameters":{"url":"=https://api.retellai.com/v2/get-call/{{ $('Voice agent for customer').item.json.call_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer key_f4ec5170781e8a750806dc78b966"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-576,1184],"id":"cc5b8961-6c8f-419c-8b73-bc2807fb1105","name":"call summary"},{"parameters":{"jsCode":"return items.map(item => {\n  const data = item.json;\n\n  // Remove large or unnecessary fields\n         // remove transcript object\n  delete data.transcript_text;    // remove text version (if exists)\n  delete data.messages;           // remove any message logs\n  delete data.call_audio; \n  delete data.transcript_object;\n  delete data.transcript_with_tool_calls;// optional, if not needed\n\n  return { json: data };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-368,1184],"id":"d60c3dbb-f636-4f03-a864-b31dff0e08a3","name":"to remove anything1"},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1CyYUWyF7n6fxx-sIEfGJqyNymPvAJ7pFdeI3phL7Q9s","mode":"list","cachedResultName":"New Data","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1CyYUWyF7n6fxx-sIEfGJqyNymPvAJ7pFdeI3phL7Q9s/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1CyYUWyF7n6fxx-sIEfGJqyNymPvAJ7pFdeI3phL7Q9s/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"call_id","displayName":"call_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_type","displayName":"call_type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"agent_id","displayName":"agent_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"agent_version","displayName":"agent_version","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"retell_llm_dynamic_variables","displayName":"retell_llm_dynamic_variables","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_status","displayName":"call_status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"start_timestamp","displayName":"start_timestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"end_timestamp","displayName":"end_timestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"duration_ms","displayName":"duration_ms","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"transcript","displayName":"transcript","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"recording_url","displayName":"recording_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"recording_multi_channel_url","displayName":"recording_multi_channel_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"public_log_url","displayName":"public_log_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"disconnection_reason","displayName":"disconnection_reason","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"latency","displayName":"latency","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_cost","displayName":"call_cost","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_analysis","displayName":"call_analysis","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"opt_out_sensitive_data_storage","displayName":"opt_out_sensitive_data_storage","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"data_storage_setting","displayName":"data_storage_setting","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"opt_in_signed_url","displayName":"opt_in_signed_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"llm_token_usage","displayName":"llm_token_usage","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"from_number","displayName":"from_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"to_number","displayName":"to_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"direction","displayName":"direction","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"telephony_identifier","displayName":"telephony_identifier","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[-192,1184],"id":"a8be3558-4e82-45a4-948e-14e417a91c8f","name":"Append row in sheet1","credentials":{"googleSheetsOAuth2Api":{"id":"LZ3OAJFvgzdGCnkM","name":"Google Sheets account"}}},{"parameters":{"url":"=https://api.retellai.com/v2/get-call/{{ $('Voice agent for caregiver').item.json.call_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer key_f4ec5170781e8a750806dc78b966"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-128,256],"id":"8c8a6cc6-6e90-46e5-bba3-cf9610f0cd65","name":"call summary2"},{"parameters":{"jsCode":"return items.map(item => {\n  const data = item.json;\n\n  // Remove large or unnecessary fields\n         // remove transcript object\n  delete data.transcript_text;    // remove text version (if exists)\n  delete data.messages;           // remove any message logs\n  delete data.call_audio; \n  delete data.transcript_object;\n  delete data.transcript_with_tool_calls;// optional, if not needed\n\n  return { json: data };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[80,256],"id":"c7424b98-56c4-49b7-b586-ece3bb7a957d","name":"to remove anything2"},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1CyYUWyF7n6fxx-sIEfGJqyNymPvAJ7pFdeI3phL7Q9s","mode":"list","cachedResultName":"New Data","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1CyYUWyF7n6fxx-sIEfGJqyNymPvAJ7pFdeI3phL7Q9s/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1CyYUWyF7n6fxx-sIEfGJqyNymPvAJ7pFdeI3phL7Q9s/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"call_id","displayName":"call_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_type","displayName":"call_type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"agent_id","displayName":"agent_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"agent_version","displayName":"agent_version","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"retell_llm_dynamic_variables","displayName":"retell_llm_dynamic_variables","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_status","displayName":"call_status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"start_timestamp","displayName":"start_timestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"end_timestamp","displayName":"end_timestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"duration_ms","displayName":"duration_ms","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"transcript","displayName":"transcript","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"recording_url","displayName":"recording_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"recording_multi_channel_url","displayName":"recording_multi_channel_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"public_log_url","displayName":"public_log_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"disconnection_reason","displayName":"disconnection_reason","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"latency","displayName":"latency","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_cost","displayName":"call_cost","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_analysis","displayName":"call_analysis","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"opt_out_sensitive_data_storage","displayName":"opt_out_sensitive_data_storage","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"data_storage_setting","displayName":"data_storage_setting","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"opt_in_signed_url","displayName":"opt_in_signed_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"llm_token_usage","displayName":"llm_token_usage","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"from_number","displayName":"from_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"to_number","displayName":"to_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"direction","displayName":"direction","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"telephony_identifier","displayName":"telephony_identifier","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[288,256],"id":"bec3d075-a5b4-46f6-8a0f-1998988f7b8c","name":"Append row in sheet2","credentials":{"googleSheetsOAuth2Api":{"id":"LZ3OAJFvgzdGCnkM","name":"Google Sheets account"}}},{"parameters":{"jsCode":"return items.map(item => {\n  const data = item.json;\n\n  // Remove large or unnecessary fields\n         // remove transcript object\n  delete data.transcript_text;    // remove text version (if exists)\n  delete data.messages;           // remove any message logs\n  delete data.call_audio; \n  delete data.transcript_object;\n  delete data.transcript_with_tool_calls;// optional, if not needed\n\n  return { json: data };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[416,1520],"id":"d9722459-1e39-4885-8361-649d563ab2fc","name":"to remove anything3"},{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1CyYUWyF7n6fxx-sIEfGJqyNymPvAJ7pFdeI3phL7Q9s","mode":"list","cachedResultName":"New Data","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1CyYUWyF7n6fxx-sIEfGJqyNymPvAJ7pFdeI3phL7Q9s/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Sheet1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1CyYUWyF7n6fxx-sIEfGJqyNymPvAJ7pFdeI3phL7Q9s/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":[],"schema":[{"id":"call_id","displayName":"call_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_type","displayName":"call_type","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"agent_id","displayName":"agent_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"agent_version","displayName":"agent_version","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"agent_name","displayName":"agent_name","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"retell_llm_dynamic_variables","displayName":"retell_llm_dynamic_variables","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_status","displayName":"call_status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"start_timestamp","displayName":"start_timestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"end_timestamp","displayName":"end_timestamp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"duration_ms","displayName":"duration_ms","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"transcript","displayName":"transcript","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"recording_url","displayName":"recording_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"recording_multi_channel_url","displayName":"recording_multi_channel_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"public_log_url","displayName":"public_log_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"disconnection_reason","displayName":"disconnection_reason","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"latency","displayName":"latency","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_cost","displayName":"call_cost","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"call_analysis","displayName":"call_analysis","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"opt_out_sensitive_data_storage","displayName":"opt_out_sensitive_data_storage","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"data_storage_setting","displayName":"data_storage_setting","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"opt_in_signed_url","displayName":"opt_in_signed_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"llm_token_usage","displayName":"llm_token_usage","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"from_number","displayName":"from_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"to_number","displayName":"to_number","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"direction","displayName":"direction","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"telephony_identifier","displayName":"telephony_identifier","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[592,1520],"id":"17a0a27f-81fc-4c4e-b784-b01b0346b9af","name":"Append row in sheet3","credentials":{"googleSheetsOAuth2Api":{"id":"LZ3OAJFvgzdGCnkM","name":"Google Sheets account"}}},{"parameters":{"method":"POST","url":"https://api.retellai.com/v2/create-phone-call","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer key_f4ec5170781e8a750806dc78b966"},{"name":"Content-Type","value":"application/json"},{"name":"Agent_id","value":"=agent_ccd42f6c2d5e3b8a25ee78d458"},{"name":"Retell_llm","value":"=llm_3cb665ddffbd7d51e543fb902168"},{"name":"Agent_version","value":"6"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"from_number","value":"=+15086257920"},{"name":"to_number","value":"={{ $json.to_number }}"},{"name":"retell_llm_dynamic_variables","value":"={{ $json.retell_llm_dynamic_variables }}"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-336,1520],"id":"046803e7-a7b7-4374-8495-70ca4c050834","name":"Voice agent for customer1","alwaysOutputData":true},{"parameters":{"url":"=https://api.retellai.com/v2/get-call/{{ $('Voice agent for customer').item.json.call_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer key_f4ec5170781e8a750806dc78b966"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[224,1520],"id":"8c8d3e3b-226b-49c5-bc01-cc683d22ea85","name":"call summary3"},{"parameters":{"from":"={{ $json.from_number }}","to":"={{ $json.to_number }}","message":"={{ $json.retell_llm_dynamic_variables.message }}","options":{}},"type":"n8n-nodes-base.twilio","typeVersion":1,"position":[-240,768],"id":"0a71ea97-1f86-41ab-a2e0-f42f417cb674","name":"Send an SMS/MMS/WhatsApp message","credentials":{"twilioApi":{"id":"Vx8PYlxEQigh63Mx","name":"Twilio account"}}},{"parameters":{"from":"={{ $json.from_number }}","to":"={{ $json.to_number }}","message":"={{ $json.retell_llm_dynamic_variables.message }}","options":{}},"type":"n8n-nodes-base.twilio","typeVersion":1,"position":[-768,-512],"id":"7e02ba2a-ba02-48c1-8393-a99bfff8693f","name":"Send an SMS/MMS/WhatsApp message1","credentials":{"twilioApi":{"id":"Vx8PYlxEQigh63Mx","name":"Twilio account"}}}],"connections":{"Schedule Trigger":{"main":[[{"node":"Customer","type":"main","index":0},{"node":"Get row(s) in sheet1","type":"main","index":0}]]},"date&time":{"main":[[{"node":"Calendar","type":"main","index":0}]]},"Calendar":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Customer":{"main":[[{"node":"date&time","type":"main","index":0},{"node":"Merge","type":"main","index":1}]]},"call summary1":{"main":[[{"node":"to remove anything","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Reminder check","type":"main","index":0}]]},"Reminder check":{"main":[[{"node":"call +","type":"main","index":0}]]},"call +":{"main":[[{"node":"current date","type":"main","index":0}]]},"current date":{"main":[[{"node":"retell dynamic variables","type":"main","index":0}]]},"retell dynamic variables":{"main":[[{"node":"Voice agent for customer","type":"main","index":0},{"node":"Send an SMS/MMS/WhatsApp message","type":"main","index":0}]]},"Voice agent for customer":{"main":[[{"node":"Wait1","type":"main","index":0}]]},"Code6":{"main":[[{"node":"Voice agent for caregiver","type":"main","index":0},{"node":"Send an SMS/MMS/WhatsApp message1","type":"main","index":0}]]},"Get row(s) in sheet1":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Edit Fields1","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Code6","type":"main","index":0}]]},"Voice agent for caregiver":{"main":[[{"node":"Wait","type":"main","index":0}]]},"call id":{"main":[[{"node":"If","type":"main","index":0}]]},"to remove anything":{"main":[[{"node":"Append row in sheet","type":"main","index":0}]]},"Wait":{"main":[[{"node":"call id","type":"main","index":0}]]},"If":{"main":[[{"node":"call summary1","type":"main","index":0}],[{"node":"Wait2","type":"main","index":0}]]},"Wait2":{"main":[[{"node":"Voice agent for caregiver2","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"call id1","type":"main","index":0}]]},"call id1":{"main":[[{"node":"If1","type":"main","index":0}]]},"Wait3":{"main":[[{"node":"call id2","type":"main","index":0}]]},"Voice agent for caregiver2":{"main":[[{"node":"Wait3","type":"main","index":0}]]},"If1":{"main":[[{"node":"call summary","type":"main","index":0}],[{"node":"Wait4","type":"main","index":0}]]},"Wait4":{"main":[[{"node":"Voice agent for customer1","type":"main","index":0}]]},"Wait5":{"main":[[{"node":"call id3","type":"main","index":0}]]},"call summary":{"main":[[{"node":"to remove anything1","type":"main","index":0}]]},"to remove anything1":{"main":[[{"node":"Append row in sheet1","type":"main","index":0}]]},"call summary2":{"main":[[{"node":"to remove anything2","type":"main","index":0}]]},"to remove anything2":{"main":[[{"node":"Append row in sheet2","type":"main","index":0}]]},"to remove anything3":{"main":[[{"node":"Append row in sheet3","type":"main","index":0}]]},"call id2":{"main":[[{"node":"call summary2","type":"main","index":0}]]},"call id3":{"main":[[{"node":"call summary3","type":"main","index":0}]]},"Voice agent for customer1":{"main":[[{"node":"Wait5","type":"main","index":0}]]},"call summary3":{"main":[[{"node":"to remove anything3","type":"main","index":0}]]},"Append row in sheet3":{"main":[[]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"7a768bea-60d6-426c-92d8-d699955dfb33","versionCounter":5,"triggerCount":0,"tags":[],"shared":[{"updatedAt":"2025-10-03T10:03:52.175Z","createdAt":"2025-10-03T10:03:52.175Z","role":"workflow:owner","workflowId":"MbmM2JS2MHzBT1dG","projectId":"dXZmqJOcr4o1Sk3u","project":{"updatedAt":"2025-08-20T05:21:32.887Z","createdAt":"2025-08-19T08:30:10.439Z","id":"dXZmqJOcr4o1Sk3u","name":"Sri Srividhya <kolipakasrividhya135@gmail.com>","type":"personal","icon":null,"description":null}}]}]